{% extends "base.html" %}
{% block content %}
<div class="record-form">
    <h2 style="text-align: center;">Верификация работодателя</h2>
    <form method="post" enctype="multipart/form-data">
        <div class="form-group">
            <label for="company_name">Название компании / ИП</label>
            <!-- Поле ввода для поиска организации -->
            <input type="text" name="company_name" id="company_name" required>

            <!-- Список для подсказок -->
            <ul id="org-suggestions" style="margin-top: 0.5rem; border: 1px solid #ccc; border-radius: 4px; list-style: none; max-height: 200px; overflow-y: auto; padding: 0;"></ul>
        </div>

        <div class="form-group">
            <label for="city">Город регистрации</label>
            <input type="text" name="city" id="city" required>
        </div>

        <div class="form-group">
            <label for="inn_or_ogrn">ИНН / ОГРНИП / ОГРН</label>
            <input type="text" name="inn_or_ogrn" id="inn_or_ogrn" required>
        </div>

        <div class="form-group">
            <label for="passport_file">Фото паспорта (1-я страница)</label>
            <input type="file" name="passport_file" id="passport_file" accept="image/*,.pdf" required>
        </div>

        {% if error_message %}
            <p style="color: red; font-weight: bold;">{{ error_message }}</p>
        {% endif %}

        <div style="text-align: center;">
            <button type="submit" class="big-button">Отправить на проверку</button>
        </div>
    </form>
</div>

<!-- Скрипт в самом низу, чтобы элементы были доступны -->
<script>
const inputEl = document.getElementById('company_name');
const listEl = document.getElementById('org-suggestions');

// Чтобы избежать слишком частых запросов
let timerId;

inputEl.addEventListener('input', () => {
  const query = inputEl.value.trim();
  if (query.length < 2) {
    listEl.innerHTML = "";
    return;
  }

  clearTimeout(timerId);
  timerId = setTimeout(() => {
    loadSuggestions(query);
  }, 300);
});

async function loadSuggestions(query) {
  try {
    const response = await fetch(`/autocomplete/orgs?query=${encodeURIComponent(query)}`);
    const data = await response.json();  // { "results": [ ... ] }
    listEl.innerHTML = "";
    data.results.forEach(org => {
      const li = document.createElement('li');
      li.style.padding = '0.5rem';
      li.style.cursor = 'pointer';
      li.textContent = org.value; // Название организации
      li.addEventListener('click', () => {
        // Подставляем в инпут
        inputEl.value = org.value;

        // Дополнительно, если хотим подставлять ИНН, ОГРН, город
        // document.getElementById('inn_or_ogrn').value = org.inn || org.ogrn;
        // document.getElementById('city').value = org.address; // или вручную парсить

        listEl.innerHTML = "";
      });
      li.addEventListener('mouseover', () => {
        li.style.backgroundColor = '#eee';
      });
      li.addEventListener('mouseout', () => {
        li.style.backgroundColor = '#fff';
      });

      listEl.appendChild(li);
    });
  } catch (err) {
    console.error(err);
  }
}
</script>
{% endblock %}
